!function(s,l){"use strict";wptelegram.bot_api_client=function(e){this.bot_token=e,this.base_url=wptelegram.ajax.url,this.proxy={script_url:""},this.get_settings=function(e,t){void 0!==wptelegram.current.event&&wptelegram.current.event.shiftKey&&(wptelegram.ajax.use="browser");var a,n,r={type:"POST",dataType:"json",crossDomain:!0};return a=this.proxy.script_url?(n=this.proxy.script_url,{bot_token:this.bot_token,method:e,args:JSON.stringify(t)}):"browser"==wptelegram.ajax.use?(n=this.build_url(e),t):(r.crossDomain=!1,n=this.build_url(),{action:"wptelegram_test",nonce:wptelegram.ajax.nonce,bot_token:this.bot_token,api_method:e,api_params:t}),r.url=n,r.data=a,r},this.build_url=function(e){return"browser"===wptelegram.ajax.use?(this.base_url="https://api.telegram.org",this.base_url+"/bot"+this.bot_token+"/"+e):this.base_url=wptelegram.ajax.url},this.sendRequest=function(e,t,a,n){if(this.bot_token){var r=this.get_settings(e,t);return r.complete=function(e){a(e,t,n),wptelegram.release_button(),wptelegram.ajax.use="server"},s.ajax(r)}console.error(l.empty_bot_token)}},wptelegram.bot_api=new window.Proxy(new wptelegram.bot_api_client,{get:function(n,r){return void 0===n[r]?function(e,t,a){return n.sendRequest(r,e,t,a)}:"function"!=typeof n[r]&&n[r]},set:function(e,t,a){return"function"!=typeof e[t]&&"base_url"!=t&&(e[t]=a,!0)}}),wptelegram.bot_api.bot_token=wptelegram.bot_token,wptelegram.current={},wptelegram.set_event=function(e){return wptelegram.current.event=e,wptelegram},wptelegram.lock_button=function(e){(wptelegram.current.button=e).length&&(e.prop("disabled",!0),e.text(l.please_wait))},wptelegram.release_button=function(){if(void 0!==wptelegram.current.button){var e=wptelegram.current.button;e.length&&(e.prop("disabled",!1),e.text(e.attr("data-text")))}wptelegram.current={}},wptelegram.utils={},wptelegram.utils.insertAtCaretDiv=function(e,t){var a,n;if(window.getSelection){if((a=window.getSelection()).getRangeAt&&a.rangeCount){(n=a.getRangeAt(0)).deleteContents();var r=document.createElement("div");r.innerHTML=e;for(var o,i,s=document.createDocumentFragment();o=r.firstChild;)i=s.appendChild(o);var l=s.firstChild;n.insertNode(s),i&&((n=n.cloneRange()).setStartAfter(i),t?n.setStartBefore(l):n.collapse(!0),a.removeAllRanges(),a.addRange(n))}}else if((a=document.selection)&&"Control"!=a.type){var c=a.createRange();c.collapse(!0),a.createRange().pasteHTML(e),(n=a.createRange()).setEndPoint("StartToStart",c),n.select()}},wptelegram.utils.insertAtCaretTextarea=function(e,t){var a=e.scrollTop,n=0,r=e.selectionStart||"0"==e.selectionStart?"ff":!!document.selection&&"ie";if("ie"==r){e.focus();var o=document.selection.createRange();o.moveStart("character",-e.value.length),n=o.text.length}else"ff"==r&&(n=e.selectionStart);var i=e.value.substring(0,n),s=e.value.substring(n,e.value.length);if(e.value=i+t+s,n+=t.length,"ie"==r){e.focus();var l=document.selection.createRange();l.moveStart("character",-e.value.length),l.moveStart("character",n),l.moveEnd("character",0),l.select()}else"ff"==r&&(e.selectionStart=n,e.selectionEnd=n,e.focus());e.scrollTop=a},wptelegram.utils.uniqid=function(e,t){var a;void 0===e&&(e="");var n=function(e,t){return t<(e=parseInt(e,10).toString(16)).length?e.slice(e.length-t):t>e.length?Array(t-e.length+1).join("0")+e:e};return this.php_js||(this.php_js={}),this.php_js.uniqidSeed||(this.php_js.uniqidSeed=Math.floor(123456789*Math.random())),this.php_js.uniqidSeed++,a=e,a+=n(parseInt((new Date).getTime()/1e3,10),8),a+=n(this.php_js.uniqidSeed,5),t&&(a+=(10*Math.random()).toFixed(8).toString()),a},wptelegram.utils.is_valid=function(e,t){var a;switch(t=t.trim().replace(/[\s@]/g,""),e){case"bot_token":a=/^\d{9}:[\w-]{35}$/;break;case"username":case"bot_username":a=/^[a-z]\w{3,30}[^\W_]$/i;break;case"chat_id":a=/^\-?[^0\D]\d{6,51}$/i}return a.test(t)},wptelegram.utils.validate=function(e,t){e.val(e.val().trim().replace(/[\s@]/g,"")),void 0===t&&(t=e.attr("data-validation"));var a=e.closest(".cmb-td");return wptelegram.utils.is_valid(t,e.val())?(a.find("."+t+"-err").addClass("hidden"),!0):(a.find("."+t+"-err").removeClass("hidden"),!1)},wptelegram.utils.send_test_message=function(e,t){e=e.split(",");var a=window.prompt(l.send_test_prompt,l.send_test_text);if(null!=a){wptelegram.bot_api.bot_token=wptelegram.bot_token,t.find("tr:not(:first)").remove();for(var n=0;n<e.length;n++)e[n]&&wptelegram.bot_api.sendMessage({chat_id:e[n],text:a},wptelegram.utils.handle_send_test_message,t)}else wptelegram.release_button()},wptelegram.utils.handle_send_test_message=function(e,t,a){a.removeClass("hidden");var n,r,o=s("<tr/>"),i=s("<td/>");o.append(i.clone().text(t.chat_id)),void 0===e||""==e.responseText?o.addClass("wptelegram-info error").append(i.clone().text(l.error+" "+l.could_not_connect).attr("colspan",3)):200==e.status&&1==JSON.parse(e.responseText).ok?(r="private"==(n=JSON.parse(e.responseText).result).chat.type?n.chat.first_name+" "+(void 0===n.chat.last_name?"":n.chat.last_name):n.chat.title,o.append(i.clone().text(r)),o.append(i.clone().text(n.chat.type)),o.append(i.clone().text(l.success))):(n=JSON.parse(e.responseText),o.addClass("wptelegram-info error").append(i.clone().text(l.error+" "+n.error_code+" - "+n.description).attr("colspan",3))),a.find("tbody").append(o)}}(jQuery,wptelegram.l10n),function(i,d,s){"use strict";var l={configure:function(){l.metabox=i("#cmb2-metabox-wptelegram"),l.common_box=i(".wptelegram-box"),l.bot_token=l.metabox.find("#bot_token"),l.bot_username=l.metabox.find("#bot_username")},set_read_only_fields:function(){l.common_box.find(".readonly input").prop("readonly",!0)},init:function(){l.configure(),l.set_read_only_fields(),l.common_box.on("blur","#bot_token,#bot_username",l.handle_blur),l.common_box.on("click",".test-bot_token",l.test_bot_token),l.common_box.on("dblclick",".readonly input",l.handle_double_click),l.common_box.on("click",".wptelegram-macro .btn",l.click_to_insert),l.common_box.on("click",".wptelegram-macro .btn",l.click_to_insert),l.emojionearea_init()},emojionearea_init:function(){var a;"function"==typeof i().emojioneArea&&(a=window.matchMedia("(max-width: 800px)").matches?"top":"left",l.common_box.find(".emojionearea-enabled textarea").each(function(){var e={hideSource:!0,pickerPosition:a,tonesStyle:"radio"},t=i(this).attr("data-emoji-container");t&&(i(t).length||i(this).before(i("<div/>",{id:t})),e.container="#"+t),i(this).emojioneArea(e)}))},click_to_insert:function(e){e.preventDefault();var t=i(this).closest(".cmb-td .wptelegram-macro").attr("data-target")+"-template-container",a=i("#"+t).find(".emojionearea-editor"),n=this.innerText;"function"==typeof i().emojioneArea&&a.length?(a.focus(),wptelegram.utils.insertAtCaretDiv(n,!0)):(a=i('textarea[data-emoji-container="'+t+'"]'),wptelegram.utils.insertAtCaretTextarea(a[0],n))},handle_blur:function(){var e=i(this);e.closest(".cmb-td").find(".wptelegram-info").addClass("hidden"),e.val()&&wptelegram.utils.validate(e)},handle_double_click:function(){var e=i(this).val();i(this).prop("readonly",!1).focus().val("").val(e)},test_bot_token:function(e){var t=i(this),a=t.attr("data-target"),n=t.closest("."+a),r=n.find("input[type=text]"),o=n.find("."+a+"-info");if(r.val())if(wptelegram.utils.validate(r))switch(wptelegram.set_event(e).lock_button(t),a){case"bot_token":s.bot_token=r.val(),s.getMe({},l.handle_bot_token_test,[o,a])}else window.alert(d.invalid_bot_token);else window.alert(d.empty_bot_token)},handle_bot_token_test:function(e,t,a){var n=a[0],r=a[1],o=n.closest("."+r);o.find("."+r+"-test").removeClass("hidden"),n.removeClass("hidden");var i,s=o.closest(".wptelegram-box").find("#bot_username");if(void 0===e||""==e.responseText)i=d.error+" "+d.could_not_connect,n.removeClass("info").addClass("error");else if(200==e.status&&1==JSON.parse(e.responseText).ok){n.removeClass("error").addClass("info");var l=JSON.parse(e.responseText).result;i=l.first_name+" "+(void 0===l.last_name?" ":l.last_name)+"(@"+l.username+")",s.val(l.username).trigger("blur")}else{var c=JSON.parse(e.responseText);n.removeClass("info").addClass("error"),i=d.error+" "+c.error_code+" - "+c.description}n.text(i)}};i(l.init)}(jQuery,wptelegram.l10n,wptelegram.bot_api);